!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";var r=function(){function e(e){this.config=e,this.ALL="ALL",this.retryCount=0,this.listener={},this.promiseMaps={},this.socketOpen=!1,this.messageQueue=[],this.config.retryInterval=this.config.retryInterval&&this.config.retryInterval>100?this.config.retryInterval:3e3,this.listen().connect().afterConnect()}return e.prototype.send=function(e,t){var n=this.wrapMsg(e),r=this;return new Promise(function(e,i){if(r.promiseMaps[n.id]={resolve:e,reject:i,promise:this},r.socketOpen)try{wx.sendSocketMessage({data:JSON.stringify(n),success:function(){t.noResponse&&(r.finishRequest(n.id),e())},fail:function(){r.finishRequest(n.id),i()}})}catch(e){i(e),r.finishRequest(n.id)}else r.messageQueue.push({content:n,config:t,timestamp:(new Date).getTime()})})},e.prototype.on=function(t,n){var r,i=this;switch(arguments.length){case 1:r=this.ALL,n=arguments[0];break;case 2:r=arguments[0],n=arguments[1];break;default:throw new Error("Invalid argument")}if(!e.helper.isString(r))throw new Error("type argument must be a string");if(!e.helper.isFunction(n))throw new Error("callback argument must be a function");this.listener[r]=this.listener[r]||[],this.listener[r].push(n);var o=this.listener[r].length-1;return function(){return i.listener[r].splice(o,1)}},e.prototype.listen=function(){var e=this;return wx.onSocketOpen(function(){console.info("WebSocket已连接"),e.retryCount=0,e.socketOpen=!0,e.messageQueue.forEach(function(t){return e.send(t.content,t.config)}),e.messageQueue=[]}),wx.onSocketError(function(){console.error("WebSocket连接打开失败，请检查！"),e.socketOpen=!1}),this},e.prototype.connect=function(){return wx.connectSocket({url:this.config.url,header:{"content-type":"application/json"}}),this},e.prototype.afterConnect=function(){var t=this;return wx.onSocketClose(function(){t.socketOpen=!1,setTimeout(function(){return t.retry()},t.config.retryInterval)}),wx.onSocketMessage(function(n){var r=n.data;try{r=JSON.parse(r)}catch(e){}var i=t.promiseMaps[r.id];r.id&&i&&(t.finishRequest(r.id),i.resolve.call(i.promise,r));var o=[];for(var s in t.listener)t.listener.hasOwnProperty(s)&&r.type===s&&(o=t.listener[s]);o=(t.listener[t.ALL]||[]).concat(o),o.forEach(function(t){return e.helper.isFunction(t)&&t(r)})}),this},e.prototype.wrapMsg=function(t){return e.helper.isPlainObject(t)&&t.type?(t.id?void 0:t.id=e.helper.id,t):this.wrapMsg({type:"message",msg:t,id:e.helper.id})},e.prototype.finishRequest=function(e){return this.promiseMaps[e]=null,delete this.promiseMaps[e],this},e.prototype.retry=function(){if(!(this.socketOpen||this.config.retryTimes>0&&this.config.retryTimes<=this.retryCount))return this.retryCount+=1,console.warn("第[ "+this.retryCount+" ]次尝试重连WebSocket"),this.connect(),this},e}();r.helper={messageIndex:0,isFunction:function(e){return"function"==typeof e},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isObject:function(e){return"object"==typeof e&&null!==e},isPlainObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},get nextId(){return this.messageIndex++},get id(){return Date.now()+"."+this.nextId}},Object.defineProperty(t,"__esModule",{value:!0}),t.default=r}])});