!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";var r=function(){function t(t){this.config=t,this.ALL="ALL",this.retryCount=0,this.listener={},this.socketOpen=!1,this.messageQueue=[],this.promiseMaps={},this.config.retryInterval=this.config.retryInterval&&this.config.retryInterval>100?this.config.retryInterval:3e3,this.listen().connect().afterConnect()}return t.prototype.send=function(t,e){void 0===e&&(e={});var n=this.wrapMsg(t),r=this;return new Promise(function(t,i){if(r.promiseMaps[n.id]={resolve:t,reject:i,promise:this},r.socketOpen)try{wx.sendSocketMessage({data:JSON.stringify(n),success:function(){r.finishRequest(n.id),t()},fail:function(){r.finishRequest(n.id),i()}})}catch(t){i(t),r.finishRequest(n.id)}else r.messageQueue.push({content:n,config:e,timestamp:(new Date).getTime()})})},t.prototype.on=function(e,n){var r,i=this;switch(arguments.length){case 1:r=this.ALL,n=arguments[0];break;case 2:r=arguments[0],n=arguments[1];break;default:throw new Error("Invalid argument")}if(!t.helper.isString(r))throw new Error("type argument must be a string");if(!t.helper.isFunction(n))throw new Error("callback argument must be a function");this.listener[r]=this.listener[r]||[],this.listener[r].push(n);var o=this.listener[r].length-1;return function(){return i.listener[r].splice(o,1)}},t.prototype.listen=function(){var t=this;return wx.onSocketOpen(function(){console.info("WebSocket已连接"),t.retryCount=0,t.socketOpen=!0,t.messageQueue.forEach(function(e){return t.send(e.content,e.config)}),t.messageQueue=[]}),wx.onSocketError(function(){console.error("WebSocket连接打开失败，请检查！"),t.socketOpen=!1}),this},t.prototype.connect=function(){return wx.connectSocket({url:this.config.url,header:{"content-type":"application/json"}}),this},t.prototype.afterConnect=function(){var t=this;return wx.onSocketClose(function(){t.socketOpen=!1,setTimeout(function(){return t.retry()},t.config.retryInterval)}),wx.onSocketMessage(function(e){var n=e.data;try{n=JSON.parse(n)}catch(t){}var r=t.promiseMaps[n.id];n.id&&r&&(t.finishRequest(n.id),r.resolve.call(r.promise,n));var i=[];for(var o in t.listener)t.listener.hasOwnProperty(o)&&n.type===o&&(i=t.listener[o]);i=(t.listener[t.ALL]||[]).concat(i),i.forEach(function(t){return"function"==typeof t&&t(n)})}),this},t.prototype.wrapMsg=function(e){return t.helper.isPlainObject(e)&&e.type?(e.id?void 0:e.id=t.helper.id,e):this.wrapMsg({type:"message",msg:e,id:t.helper.id})},t.prototype.finishRequest=function(t){return this.promiseMaps[t]=null,delete this.promiseMaps[t],this},t.prototype.retry=function(){if(!(this.socketOpen||this.config.retryTimes>0&&this.config.retryTimes<=this.retryCount))return this.retryCount+=1,console.warn("第[ "+this.retryCount+" ]次尝试重连WebSocket"),this.connect(),this},t}();r.helper={isFunction:function(t){return"function"==typeof t},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isObject:function(t){return"object"==typeof t&&null!==t},isPlainObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},get id(){return Date.now()+Math.random().toString().substr(2,3)}},Object.defineProperty(e,"__esModule",{value:!0}),e.default=r}])});